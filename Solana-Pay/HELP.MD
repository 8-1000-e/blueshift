# Guide par Indices : Impl√©menter les References Solana Pay

## Le Parcours en 4 Grandes √âtapes

1. **G√©n√©rer une reference** ‚Üí Une adresse Solana al√©atoire
2. **Cr√©er l'URL de paiement** ‚Üí Avec la reference dedans
3. **Surveiller la blockchain** ‚Üí Chercher si la reference appara√Æt
4. **R√©agir quand trouv√©** ‚Üí Afficher un message de succ√®s

---

## PARTIE 1 : G√©n√©rer une Reference

### Ce que tu dois faire
Cr√©er une nouvelle adresse Solana qui servira d'identifiant unique pour ce paiement.

### Les outils √† utiliser
- La classe `Keypair` de `@solana/web3.js`
- Sa m√©thode statique `generate()`
- La propri√©t√© `publicKey` du keypair g√©n√©r√©

### Comment penser
- Tu ne veux PAS garder la cl√© priv√©e
- Tu veux juste la cl√© publique (l'adresse)
- Cette adresse ne recevra jamais d'argent, elle sert juste de marqueur

### O√π stocker cette reference
- Dans un state React (useState)
- Tu en auras besoin pour construire l'URL ET pour la surveillance

### Comment afficher
- Les PublicKey ont une m√©thode `.toBase58()` qui les convertit en string lisible

### √Ä tester
- G√©n√®re plusieurs references
- V√©rifie qu'elles sont diff√©rentes √† chaque fois
- Console.log pour voir √† quoi elles ressemblent

---

## PARTIE 2 : Construire l'URL de Paiement

### La structure d'une URL Solana Pay
```
solana:[ADRESSE_DESTINATAIRE]?param1=value1&param2=value2
```

### Les param√®tres obligatoires
- `amount` : Le montant en SOL (nombre d√©cimal)
- `reference` : Ta reference (en string base58)

### Les param√®tres optionnels mais recommand√©s
- `label` : Nom de ton app/commerce
- `message` : Message pour l'utilisateur

### Comment construire l'URL en JavaScript
- Utilise la classe native `URL`
- Le constructeur prend la partie `solana:ADRESSE`
- Utilise `.searchParams.append(nom, valeur)` pour ajouter les param√®tres
- `.toString()` pour avoir l'URL compl√®te

### Points d'attention
- Convertis ta reference PublicKey en string avec `.toBase58()`
- Convertis ton montant number en string avec `.toString()`
- Tous les param√®tres doivent √™tre des strings

### O√π obtenir l'adresse destinataire
- C'est TON adresse Solana o√π tu veux recevoir l'argent
- Pour tester : utilise devnet
- Phantom wallet : Settings ‚Üí Developer Settings ‚Üí Change Network ‚Üí Devnet
- Copie ton adresse devnet

### √Ä tester
- G√©n√®re une URL
- Copie-colle-la dans la barre d'adresse
- Phantom devrait s'ouvrir automatiquement
- Tu dois voir les d√©tails du paiement (montant, destinataire)

---

## PARTIE 3 : La Connexion Solana

### Ce qu'il te faut
Un objet `Connection` qui te permet de communiquer avec le r√©seau Solana.

### Comment le cr√©er
- Utilise la classe `Connection` de `@solana/web3.js`
- Le constructeur prend une URL de RPC en param√®tre

### Les URLs de RPC
- Devnet : `"https://api.devnet.solana.com"`
- Mainnet : `"https://api.mainnet-beta.solana.com"`

### O√π le cr√©er
- EN DEHORS de ton composant React (sinon il se recr√©e √† chaque render)
- Ou dans un useEffect sans d√©pendances si tu veux qu'il soit dans le composant

### √Ä tester
- Appelle `connection.getVersion()` pour v√©rifier que √ßa marche
- C'est une fonction async, utilise await
- Tu dois recevoir un objet avec la version de Solana

---

## PARTIE 4 : La Surveillance (Le Gros Morceau)

### L'id√©e g√©n√©rale
Tu vas cr√©er une boucle qui v√©rifie toutes les secondes si ta reference est apparue sur la blockchain.

### Les outils React n√©cessaires

**useState** pour :
- Stocker le statut du paiement ("waiting", "found", "error")
- Pouvoir mettre √† jour l'interface

**useRef** pour :
- Garder en m√©moire la derni√®re transaction trouv√©e
- Sans provoquer de re-render

**useEffect** pour :
- Lancer la surveillance quand la reference est cr√©√©e
- Nettoyer quand le composant se d√©monte

### La fonction magique : findReference

**D'o√π elle vient ?**
- Package `@solana/pay`
- Import : `import { findReference, FindReferenceError } from '@solana/pay';`

**Ses param√®tres :**
1. La connection Solana
2. Ta reference (en PublicKey, pas en string)
3. Un objet d'options avec :
   - `until` : Ne cherche que les transactions apr√®s celle-ci
   - `finality` : Niveau de confirmation ("confirmed" ou "finalized")

**Ce qu'elle retourne :**
- Si trouv√© : un objet avec `.signature` (la signature de la transaction)
- Si pas trouv√© : lance une `FindReferenceError`

### Le pattern √† utiliser

**setInterval** :
- Fonction JavaScript native
- Ex√©cute du code toutes les X millisecondes
- Premier param√®tre : la fonction √† ex√©cuter
- Deuxi√®me param√®tre : l'intervalle en ms (1000 = 1 seconde)

**async/await** :
- Ta fonction dans setInterval doit √™tre `async`
- Utilise `await` devant `findReference`

**try/catch** :
- Entoure l'appel √† `findReference` dans un try
- Dans le catch, v√©rifie si c'est une `FindReferenceError`
- Si oui : c'est normal, continue de chercher
- Si non : c'est une vraie erreur, log-la

### La gestion de "until"

**Le probl√®me :**
Sans `until`, tu vas retrouver la m√™me transaction en boucle.

**La solution :**
- Cr√©e un useRef pour stocker la derni√®re signature trouv√©e
- Passe `mostRecentTransaction.current` dans le param√®tre `until`
- Quand tu trouves une transaction, update le ref : `ref.current = signature`

### Le cleanup

**Pourquoi c'est critique :**
Si tu oublies, ton interval va continuer √† tourner m√™me quand le composant est d√©mont√© = fuite m√©moire.

**Comment faire :**
- `useEffect` peut retourner une fonction
- Cette fonction est appel√©e au d√©montage
- Dans cette fonction : appelle `clearInterval(interval)`

### Structure du useEffect

```
useEffect(() => {
  // Si pas de reference, ne rien faire
  // Cr√©er le setInterval
  // Dans l'interval : appeler findReference
  // G√©rer les deux cas : trouv√© / pas trouv√©
  // Retourner une fonction qui fait clearInterval
}, [reference]); // D√©pendance : se relance si reference change
```

### √Ä tester

**Test 1 : Console logs**
- Ajoute des console.log √† chaque √©tape
- "D√©but surveillance"
- "V√©rification..." √† chaque boucle
- "Pas encore trouv√©" ou "Trouv√© !"

**Test 2 : Sans payer**
- Lance la surveillance
- Laisse tourner quelques secondes
- Tu dois voir les console.log se r√©p√©ter toutes les secondes

**Test 3 : Avec paiement**
- G√©n√®re l'URL
- Ouvre-la dans Phantom
- Approuve le paiement
- Attends quelques secondes
- Tu dois voir "Trouv√© !" dans la console

---

## PARTIE 5 : L'Interface Utilisateur

### Les √©tats √† afficher

**Avant g√©n√©ration :**
- Un bouton "G√©n√©rer un paiement"

**Apr√®s g√©n√©ration :**
- L'URL de paiement (en texte ou QR code)
- Un message "En attente du paiement..."

**Apr√®s d√©tection :**
- Un message "Paiement re√ßu !"
- Optionnel : la signature de la transaction

### G√©rer le statut

**Les √©tats possibles :**
- `"idle"` : Rien n'est lanc√©
- `"waiting"` : Surveillance en cours
- `"found"` : Paiement d√©tect√©
- `"error"` : Probl√®me

**Comment afficher conditionnellement :**
- Utilise des conditions `{status === "waiting" && <div>...</div>}`
- Ou un switch/if pour plus de clart√©

### Am√©lioration : QR Code

Si tu veux afficher un QR code au lieu de l'URL :
- Package : `qrcode.react`
- Composant : `<QRCode value={paymentUrl} />`

---

## √âTAPES DE TEST COMPL√àTES

### Setup Phantom

1. Installe l'extension Phantom
2. Cr√©e un wallet ou utilise un existant
3. Va dans Settings ‚Üí Developer Settings
4. Change Network ‚Üí Devnet
5. Copie ton adresse devnet

### Obtenir des SOL de test

1. Va sur https://faucet.solana.com
2. Colle ton adresse devnet
3. Demande des SOL gratuits (airdrop)
4. Attends quelques secondes
5. V√©rifie dans Phantom que tu as des SOL

### Tester ton app

**Premi√®re fois :**
1. Clique sur "G√©n√©rer un paiement"
2. Copie l'URL g√©n√©r√©e
3. Colle dans la barre d'adresse du navigateur
4. Phantom s'ouvre
5. V√©rifie le montant et le destinataire
6. Approuve
7. Attends 2-5 secondes
8. Ton app doit afficher "Paiement re√ßu !"

**V√©rifier la transaction :**
1. Va sur https://explorer.solana.com/?cluster=devnet
2. Colle la signature affich√©e dans ta console
3. Tu dois voir la transaction avec tous ses d√©tails
4. Dans les comptes, cherche ta reference
5. Elle doit √™tre l√†, en mode "read-only"

**Tester plusieurs fois :**
- G√©n√®re plusieurs paiements
- V√©rifie que chaque reference est unique
- V√©rifie que chaque paiement est d√©tect√© ind√©pendamment

---

## POINTS D'ATTENTION

### La finality

**"confirmed"** :
- Rapide (~400ms)
- Peut √™tre annul√© (tr√®s rare)
- OK pour petits montants

**"finalized"** :
- Lent (~13 secondes)
- D√©finitif, ne peut pas √™tre annul√©
- Recommand√© pour gros montants

### Les erreurs courantes

**"Cannot read property of undefined"** :
- Tu essaies d'utiliser une variable avant qu'elle existe
- V√©rifie tes conditions `if (!reference) return;`

**"Invalid public key"** :
- Tu passes une string au lieu d'une PublicKey
- Utilise `new PublicKey(stringValue)` pour convertir

**"Transaction not found"** :
- Normal ! C'est la FindReferenceError
- Ne la traite pas comme une vraie erreur

**L'interval ne s'arr√™te pas** :
- Tu oublies le `clearInterval` dans le cleanup
- Ajoute des console.log pour v√©rifier que le cleanup est appel√©

### Optimisations possibles

**Timeout** :
- Ne surveille pas ind√©finiment
- Arr√™te apr√®s 5-10 minutes si rien trouv√©

**Debounce** :
- Si tu veux √©viter trop de requ√™tes
- Augmente l'intervalle √† 2-3 secondes

**Backend** :
- Pour la production, mets la surveillance c√¥t√© serveur
- Le frontend affiche juste le statut

---

## RESSOURCES UTILES

### Documentation
- Solana Pay docs : https://docs.solanapay.com
- Solana Web3.js : https://solana-labs.github.io/solana-web3.js

### Outils
- Solana Explorer : https://explorer.solana.com
- Faucet devnet : https://faucet.solana.com
- Phantom wallet : https://phantom.app

### Debug
- Toujours console.log √† chaque √©tape
- V√©rifie dans l'Explorer que la transaction existe
- Compare les adresses (reference, destinataire) pour voir s'ils matchent

---

## R√âCAP : CE QUE TU DOIS CODER

1. **G√©n√©rer** : Une PublicKey al√©atoire
2. **Construire** : Une URL avec cette PublicKey dedans
3. **Surveiller** : Utiliser findReference dans un setInterval
4. **R√©agir** : Afficher un message quand trouv√©
5. **Nettoyer** : Arr√™ter l'interval au bon moment

C'est tout ! Maintenant code, teste, debug, et apprends en faisant üöÄ